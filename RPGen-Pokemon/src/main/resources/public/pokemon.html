<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokédex</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background-color: #181818;
            color: #f0f0f0;
        }

        .container {
            max-width: calc(100% - 500px);
            margin: 0 auto;
            padding: 20px;
        }

        /* Buscador fijo debajo del menú */
        .search-bar {
            position: fixed;
            top: 70px; /* Justo debajo del menú */
            left: 0;
            width: 100vw;
            z-index: 200;
            background: #181818;
            padding: 16px 20px 12px 20px;
            box-sizing: border-box;
            border-bottom: 1px solid #333;
        }
        body:not(.dark-mode) .search-bar {
            background: #f0f0f0;
            border-bottom: 1px solid #ccc;
        }

        body.dark-mode .search-bar input {
            background: #232323;
            color: #f0f0f0;
            border: 2px solid #444;
        }

        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .pokemon-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, background-color 0.3s, color 0.3s, border-color 0.3s;
            position: relative;
            z-index: 10;
        }
        .pokemon-card:hover {
            transform: translateY(-5px);
            z-index: 11;
        }
        body.dark-mode .pokemon-card {
            background: #232323;
            color: #e0e0e0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 1px solid #444;
        }
        body.dark-mode .pokemon-card.selected {
            background: #294d29;
            border-color: #6fcf97;
        }
        body.dark-mode .pokemon-card:hover {
            background: #333;
        }

        .pokemon-image {
            width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .pokemon-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            text-transform: capitalize;
        }

        .pokemon-types {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .type-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
            text-transform: capitalize;
        }

        .pokemon-details {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        body.dark-mode .pokemon-details {
            background: #232323;
            color: #f0f0f0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        body.dark-mode .close-button {
            color: #bbb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-item span:first-child {
            font-weight: bold;
            color: #333;
        }

        .stat-item span:last-child {
            font-weight: 600;
            color: #2196F3;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }

        /* Colores de tipos */
        .type-normal { background-color: #A8A878; }
        .type-fire { background-color: #F08030; }
        .type-water { background-color: #6890F0; }
        .type-electric { background-color: #F8D030; }
        .type-grass { background-color: #78C850; }
        .type-ice { background-color: #98D8D8; }
        .type-fighting { background-color: #C03028; }
        .type-poison { background-color: #A040A0; }
        .type-ground { background-color: #E0C068; }
        .type-flying { background-color: #A890F0; }
        .type-psychic { background-color: #F85888; }
        .type-bug { background-color: #A8B820; }
        .type-rock { background-color: #B8A038; }
        .type-ghost { background-color: #705898; }
        .type-dragon { background-color: #7038F8; }
        .type-dark { background-color: #705848; }
        .type-steel { background-color: #B8B8D0; }
        .type-fairy { background-color: #EE99AC; }

        .team-section {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 300px;
            background: white;
            padding: 20px;
            margin-top: 70px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 300;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark-mode .team-section {
            background: #232323;
            color: #f0f0f0;
            box-shadow: -2px 0 10px rgba(0,0,0,0.5);
        }

        .team-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 10px;
        }
        body.dark-mode .team-controls {
            background: #181818;
        }

        .team-controls button {
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        body.dark-mode .team-controls button {
            background-color: #294d29;
            color: #f0f0f0;
        }

        .team-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            overflow-y: auto;
        }

        .team-slot {
            background: #f5f5f5;
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s ease, background-color 0.3s, color 0.3s, border-color 0.3s;
            user-select: none;
        }
        body.dark-mode .team-slot {
            background: #232323;
            border-color: #444;
            color: #e0e0e0;
        }
        body.dark-mode .team-slot.filled {
            border-color: #6fcf97;
        }

        .team-slot img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        .team-slot .pokemon-name {
            margin-top: 5px;
            font-size: 14px;
        }

        .pokemon-card.selected {
            border: 2px solid #4CAF50;
            background-color: #e8f5e9;
        }

        .remove-pokemon {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 14px;
            display: none;
        }
        body.dark-mode .remove-pokemon {
            background: #a22;
            color: #fff;
        }

        .team-slot.filled:hover .remove-pokemon {
            display: block;
        }

        .team-selector {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .team-selector select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .team-selector button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .team-selector button.delete {
            background-color: #f44336;
        }

        .main-battle-btn {
            font-size: 1.2em;
            padding: 0.9em 2.2em;
            border-radius: 12px;
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            color: #222;
            font-weight: bold;
            border: none;
            margin: 0 0.5em 0 0;
            box-shadow: 0 2px 8px #0003;
            transition: background 0.2s, transform 0.1s;
            cursor: pointer;
        }
        .main-battle-btn:hover {
            background: linear-gradient(90deg, #38f9d7 0%, #43e97b 100%);
            transform: scale(1.05);
        }
        body.dark-mode .main-battle-btn {
            background: linear-gradient(90deg, #232b23 0%, #38f9d7 100%);
            color: #fff;
        }
        .main-battle-btn:disabled {
            background: linear-gradient(90deg, #888 0%, #999 100%);
            cursor: not-allowed;
            transform: none;
        }

        .main-content {
            margin-left: 1vw; /*Espacio para el equipo */
        }

        .moves-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1000;
        }
        body.dark-mode .moves-modal {
            background: #232323;
            color: #f0f0f0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .moves-modal.active {
            display: block;
        }

        .move-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f5f5f5;
            transition: all 0.2s ease;
            margin-bottom: 5px;
        }
        body.dark-mode .move-item {
            background: #232323;
            color: #f0f0f0;
            border-color: #444;
        }
        body.dark-mode .move-item.selected, body.dark-mode .move-item:hover {
            background: #294d29;
            border-color: #6fcf97;
            color: #fff;
        }

        .move-item .move-name {
            font-weight: bold;
            flex: 1;
        }

        .move-item .move-details {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .move-item .move-power {
            color: #666;
            font-size: 0.9em;
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .move-item .move-type {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: white;
            text-transform: capitalize;
        }

        .move-item .move-category {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7em;
            color: white;
            text-transform: capitalize;
            margin-left: 5px;
        }

        .category-physical { background-color: #C03028; }
        .category-special { background-color: #6890F0; }
        .category-status { background-color: #A8A878; }

        .moves-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .moves-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .selected-moves {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        body.dark-mode .selected-moves {
            background: #181818;
            border-color: #444;
            color: #f0f0f0;
        }

        .selected-moves h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }

        .selected-move-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .selected-move-item .remove-move {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
        }

        .pokemon-stats-modal {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .pokemon-stats-modal img {
            width: 200px;
            height: 200px;
            object-fit: contain;
        }

        .hover-details {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 300px;
            z-index: 1002;
            display: none;
            margin-top: 10px;
        }
        body.dark-mode .hover-details {
            background: #232323;
            color: #f0f0f0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .pokemon-card:hover .hover-details {
            display: block;
        }

        .config-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }

        body.dark-mode .config-section {
            background: #181818;
            border-color: #444;
            color: #f0f0f0;
        }

        .config-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }

        body.dark-mode .config-section h4 {
            color: #f0f0f0;
        }

        .ability-item, .item-item, .nature-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 5px 0;
            cursor: pointer;
            background: white;
            transition: all 0.2s ease;
        }

        body.dark-mode .ability-item, 
        body.dark-mode .item-item, 
        body.dark-mode .nature-item {
            background: #232323;
            border-color: #444;
            color: #f0f0f0;
        }

        .ability-item:hover, .item-item:hover, .nature-item:hover {
            background: #e8f5e9;
            border-color: #4CAF50;
        }

        body.dark-mode .ability-item:hover, 
        body.dark-mode .item-item:hover, 
        body.dark-mode .nature-item:hover {
            background: #294d29;
            border-color: #6fcf97;
        }

        .ability-item.selected, .item-item.selected, .nature-item.selected {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        body.dark-mode .ability-item.selected, 
        body.dark-mode .item-item.selected, 
        body.dark-mode .nature-item.selected {
            background: #6fcf97;
            color: #000;
        }

        .config-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 12px;
        }

        .config-button:hover {
            background: #1976D2;
        }

        .stats-display {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 10px !important;
            margin: 10px 0 !important;
        }

        .stat-display {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            background: #f0f0f0;
            border-radius: 3px;
        }

        body.dark-mode .stat-display {
            background: #232323;
            color: #f0f0f0;
        }

        .tab-container {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
        }

        body.dark-mode .tab-button {
            color: #bbb;
        }

        body.dark-mode .tab-button.active {
            color: #6fcf97;
            border-bottom-color: #6fcf97;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .config-section-full {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }

        body.dark-mode .config-section-full {
            background: #181818;
            border-color: #444;
            color: #f0f0f0;
        }

        .save-all-button {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            width: 100%;
        }

        .save-all-button:hover {
            background: #45a049;
        }

        /* Estilos para la sección de estadísticas calculadas en modo oscuro */
        body.dark-mode .stats-display {
            background: #181818;
        }

        body.dark-mode .stats-display h4 {
            color: #f0f0f0;
        }

        /* Estilos para el selector de naturaleza en modo oscuro */
        body.dark-mode select#natureSelect {
            background: #232323;
            color: #f0f0f0;
            border-color: #444;
        }

        body.dark-mode select#natureSelect option {
            background: #232323;
            color: #f0f0f0;
        }

        /* Estilos para la sección de naturaleza en modo oscuro */
        body.dark-mode .config-section-full {
            background: #181818;
            border-color: #444;
            color: #f0f0f0;
        }

        /* Clases para secciones con estilos inline */
        .nature-selector-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        body.dark-mode .nature-selector-section {
            background: #181818;
            border-color: #444;
            color: #f0f0f0;
        }

        .stats-calculated-section {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        body.dark-mode .stats-calculated-section {
            background: #181818;
            color: #f0f0f0;
        }

        .config-info-section {
            margin-top: 15px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        body.dark-mode .config-info-section {
            background: #181818;
            color: #f0f0f0;
        }

        /* Estilos para el selector de naturaleza en modo oscuro */
        body.dark-mode #natureSelect {
            background: #232323;
            color: #f0f0f0;
            border-color: #444;
        }

        body.dark-mode #natureSelect option {
            background: #232323;
            color: #f0f0f0;
        }

        body.dark-mode #natureSelect option {
            background: #232323;
            color: #f0f0f0;
        }

        /* Estilos para elementos h4 en modo oscuro */
        body.dark-mode .nature-selector-section h4,
        body.dark-mode .stats-calculated-section h4,
        body.dark-mode .config-info-section h4 {
            color: #f0f0f0;
        }

        /* Clase para descripciones */
        .description-text {
            font-size: 12px;
            color: #666;
        }

        body.dark-mode .description-text {
            color: #bbb;
        }

        .main-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 70px; /* Altura fija del menú */
            background: #222;
            color: #fff;
            z-index: 100;
            box-shadow: 0 2px 8px #0002;
        }
        .main-header nav {
            display: flex;
            justify-content: center;
            gap: 2em;
            padding: 1em 0;
        }
        .main-header a, .main-header .theme-toggle {
            color: #fff;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1em;
            transition: color 0.2s, background 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 0.5em;
            height: 100%;
            display: flex;
            align-items: center;
        }
        .main-header a:hover, .main-header .theme-toggle:hover {
            color: #4CAF50;
            background: none;
        }
        body.dark-mode .main-header a, body.dark-mode .main-header .theme-toggle {
            color: #f0f0f0;
        }
        body.dark-mode .main-header a:hover, body.dark-mode .main-header .theme-toggle:hover {
            color: #6fcf97;
        }
        body {
            padding-top: 70px !important;
        }
        /* Ajusta el contenido para que no quede debajo del buscador */
        .container.main-content {
            padding-top: 120px !important; /* 70px menú + 50px buscador */
        }

        /* Agrupación de inputs de estadísticas */
        .stat-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .stat-input-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            margin-bottom: 0;
        }
        .stat-input-group input[type="number"] {
            width: 60px;
            padding: 4px 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        body.dark-mode .stat-input-group input[type="number"] {
            background: #232323;
            color: #f0f0f0;
            border-color: #444;
        }

        /* Mejoras de contraste para movimientos en modo oscuro */
        body.dark-mode .move-item {
            background: #232323;
            color: #f0f0f0;
            border-color: #444;
        }
        body.dark-mode .move-item.selected, 
        body.dark-mode .move-item:hover {
            background: #294d29;
            border-color: #6fcf97;
            color: #fff;
        }
        body.dark-mode .selected-move-item {
            background: #232323;
            color: #f0f0f0;
            border: 1px solid #6fcf97;
        }
        body.dark-mode .selected-move-item .move-name {
            color: #fff;
        }
        body.dark-mode .selected-move-item .move-details {
            color: #fff;
        }
        /* Mejorar contraste de badges de tipo y categoría en modo oscuro */
        body.dark-mode .move-type,
        body.dark-mode .move-category {
            border: 1px solid #fff;
            text-shadow: 0 1px 2px #000a;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <nav>
            <a href="index.html">Inicio</a>
            <a href="pokemon.html">Pokédex</a>
            <a href="battle.html">Combate Pokémon</a>
            <a href="chrono-team.html">Selección de Equipos Chrono</a>
            <a href="chrono-battle.html">Combate Chrono Trigger</a>
            <button class="theme-toggle" onclick="toggleDarkMode()">Cambiar Tema</button>
        </nav>
    </header>
    <div class="container main-content">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Buscar Pokémon por nombre">
        </div>
        <div id="pokemonGrid" class="pokemon-grid"></div>
        <div id="loading" class="loading">Cargando Pokémon...</div>
    </div>

    <div class="team-section">
        <div class="team-controls">
        <div class="team-selector">
            <select id="teamSelector" onchange="changeTeam()">
            </select>
                <button onclick="createNewTeam()" title="Crear equipo"><i class="fa-solid fa-square-plus"></i></button>
                <button onclick="editTeamName()" title="Cambiar nombre"><i class="fa-solid fa-pen"></i></button>
                <button class="delete" onclick="deleteCurrentTeam()" title="Eliminar equipo"><i class="fa-solid fa-trash"></i></button>
        </div>
            <button class="main-battle-btn" onclick="startBattle()">Iniciar Batalla</button>
            <button class="main-battle-btn" onclick="clearTeam()">Limpiar Equipo</button>
        </div>
        <div class="team-grid" id="teamGrid">
            <!-- Los slots del equipo se generarán dinámicamente -->
        </div>
    </div>

    <div id="pokemonDetails" class="pokemon-details">
        <button class="close-button" onclick="closeDetails()">&times;</button>
        <div id="detailsContent"></div>
    </div>

    <div id="movesModal" class="moves-modal">
        <button class="close-button" onclick="closeMovesModal()">&times;</button>
        <div id="movesContent">
            <!-- Contenido dinámico con pestañas -->
        </div>
    </div>

    <div id="teamNameModal" class="moves-modal">
        <button class="close-button" onclick="closeTeamNameModal()">&times;</button>
        <div style="padding: 20px;">
            <h3 id="teamNameModalTitle">Nuevo Equipo</h3>
            <input type="text" id="newTeamName" placeholder="Nombre del equipo" style="width: 100%; padding: 8px; margin: 10px 0;">
            <button onclick="confirmNewTeam()" style="margin-top: 15px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Crear Equipo
            </button>
        </div>
    </div>

    <!-- Modal para configurar Pokémon -->
    <div id="pokemonConfigModal" class="moves-modal">
        <button class="close-button" onclick="closePokemonConfigModal()">&times;</button>
        <div style="padding: 20px;">
            <h3 id="pokemonConfigTitle">Configurar Pokémon</h3>
            <div id="pokemonConfigContent">
                <!-- Contenido dinámico -->
            </div>
        </div>
    </div>

    <!-- Modal para configurar IVs y EVs -->
    <div id="statsConfigModal" class="moves-modal">
        <button class="close-button" onclick="closeStatsConfigModal()">&times;</button>
        <div style="padding: 20px;">
            <h3>Configurar IVs y EVs</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4>IVs (0-31)</h4>
                    <div class="stat-input-group">
                        <label>HP: <input type="number" id="hpIV" min="0" max="31" value="31"></label>
                        <label>Ataque: <input type="number" id="attackIV" min="0" max="31" value="31"></label>
                        <label>Defensa: <input type="number" id="defenseIV" min="0" max="31" value="31"></label>
                        <label>Ataque Especial: <input type="number" id="specialAttackIV" min="0" max="31" value="31"></label>
                        <label>Defensa Especial: <input type="number" id="specialDefenseIV" min="0" max="31" value="31"></label>
                        <label>Velocidad: <input type="number" id="speedIV" min="0" max="31" value="31"></label>
                    </div>
                </div>
                <div>
                    <h4>EVs (0-252, máximo 510 total)</h4>
                    <div class="stat-input-group">
                        <label>HP: <input type="number" id="hpEV" min="0" max="252" value="0"></label>
                        <label>Ataque: <input type="number" id="attackEV" min="0" max="252" value="0"></label>
                        <label>Defensa: <input type="number" id="defenseEV" min="0" max="252" value="0"></label>
                        <label>Ataque Especial: <input type="number" id="specialAttackEV" min="0" max="252" value="0"></label>
                        <label>Defensa Especial: <input type="number" id="specialDefenseEV" min="0" max="252" value="0"></label>
                        <label>Velocidad: <input type="number" id="speedEV" min="0" max="252" value="0"></label>
                    </div>
                    <p id="evTotal" style="margin-top: 10px; font-weight: bold;">Total EVs: 0/510</p>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <label>Nivel: <input type="number" id="pokemonLevel" min="1" max="100" value="50"></label>
            </div>
            
            <!-- Sección de estadísticas en tiempo real -->
            <div class="stats-calculated-section">
                <h4 style="margin-top: 0;">Estadísticas Calculadas</h4>
                <div id="calculatedStats" class="stats-display">
                    <div class="stat-display"><span>HP:</span><span id="calcHP">0</span></div>
                    <div class="stat-display"><span>Ataque:</span><span id="calcAttack">0</span></div>
                    <div class="stat-display"><span>Defensa:</span><span id="calcDefense">0</span></div>
                    <div class="stat-display"><span>Ataque Especial:</span><span id="calcSpecialAttack">0</span></div>
                    <div class="stat-display"><span>Defensa Especial:</span><span id="calcSpecialDefense">0</span></div>
                    <div class="stat-display"><span>Velocidad:</span><span id="calcSpeed">0</span></div>
                </div>
            </div>
            
            <button onclick="saveStatsConfig()" style="margin-top: 15px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Guardar Configuración
            </button>
        </div>
    </div>

    <script>
        let allPokemon = [];
        let searchTimeout;
        let teams = {};
        let currentTeam = null;
        let selectedPokemonForMoves = null;
        let selectedMoves = new Set();
        const typeTranslations = {
            'normal': 'Normal',
            'fire': 'Fuego',
            'water': 'Agua',
            'electric': 'Eléctrico',
            'grass': 'Planta',
            'ice': 'Hielo',
            'fighting': 'Lucha',
            'poison': 'Veneno',
            'ground': 'Tierra',
            'flying': 'Volador',
            'psychic': 'Psíquico',
            'bug': 'Bicho',
            'rock': 'Roca',
            'ghost': 'Fantasma',
            'dragon': 'Dragón',
            'dark': 'Siniestro',
            'steel': 'Acero',
            'fairy': 'Hada'
        };

        // Inicializar slots del equipo
        function initializeTeamSlots() {
            const teamGrid = document.getElementById('teamGrid');
            teamGrid.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                teamGrid.innerHTML += `
                    <div class="team-slot" data-slot="${i}" onclick="selectTeamSlot(${i})">
                        <div class="slot-placeholder">Slot ${i + 1}</div>
                    </div>
                `;
            }
        }

        // Función para traducir tipos
        function translateType(type) {
            return typeTranslations[type.toLowerCase()] || type;
        }

        // Función para renderizar un Pokémon
        function renderPokemon(pokemon) {
            const types = pokemon.types || [];
            const typeBadges = types.map(type => 
                `<span class="type-badge type-${type.toLowerCase()}">${translateType(type)}</span>`
            ).join('');

            const isSelected = currentTeam && teams[currentTeam] ? teams[currentTeam].includes(pokemon.id) : false;
            const selectedClass = isSelected ? 'selected' : '';

            // Buscar si el Pokémon está en algún equipo para mostrar sus movimientos específicos
            let teamPokemonData = null;
            if (currentTeam && teams[currentTeam]) {
                for (const [teamName, team] of Object.entries(teams)) {
                    const index = team.indexOf(pokemon.id);
                    if (index !== -1) {
                        const pokemonHash = generatePokemonTeamHash(pokemon.id, teamName, index);
                        const savedData = localStorage.getItem(pokemonHash);
                        if (savedData) {
                            teamPokemonData = JSON.parse(savedData);
                            break;
                        }
                    }
                }
            }

            const displayData = teamPokemonData || {
                ...pokemon,
                health: pokemon.health || pokemon.maxHealth,
                maxHealth: pokemon.maxHealth,
                attack: pokemon.attack || pokemon.baseAttack,
                defense: pokemon.defense || pokemon.baseDefense,
                speed: pokemon.speed || pokemon.baseSpeed,
                specialAttack: pokemon.specialAttack || pokemon.baseSpecialAttack,
                specialDefense: pokemon.specialDefense || pokemon.baseSpecialDefense
            };

            // Obtener información de configuración
            const nature = displayData.nature ? displayData.nature.name : 'Aleatoria';
            const heldItem = displayData.heldItem && displayData.heldItem !== null && displayData.heldItem !== undefined ? displayData.heldItem.name : 'Ninguno';
            const selectedAbility = displayData.selectedAbility ? displayData.selectedAbility.name : 'Ninguna';
            const level = displayData.level || 50;

            return `
                <div class="pokemon-card ${selectedClass}" onclick="selectPokemon('${pokemon.id}')">
                    <img src="${pokemon.imageUrl}" alt="${pokemon.name}" class="pokemon-image" 
                         onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${pokemon.id}.png'">
                    <div class="pokemon-name">${pokemon.name.charAt(0).toUpperCase() + pokemon.name.slice(1)}</div>
                    <div class="pokemon-types">${typeBadges}</div>
                    
                    <!-- Botones de configuración -->
                    <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                        <button class="config-button" onclick="event.stopPropagation(); showMovesModal('${pokemon.id}', '${currentTeam || ''}', ${teams[currentTeam] ? teams[currentTeam].indexOf(pokemon.id) : -1})" title="Configurar Pokémon">
                            <i class="fa-solid fa-cog"></i>
                        </button>
                    </div>
                    
                    <div class="hover-details">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span>HP:</span>
                                <span>${displayData.health || displayData.maxHealth}/${displayData.maxHealth}</span>
                            </div>
                            <div class="stat-item">
                                <span>Ataque:</span>
                                <span>${displayData.attack || displayData.baseAttack}</span>
                            </div>
                            <div class="stat-item">
                                <span>Defensa:</span>
                                <span>${displayData.defense || displayData.baseDefense}</span>
                            </div>
                            <div class="stat-item">
                                <span>Ataque Especial:</span>
                                <span>${displayData.specialAttack || displayData.baseSpecialAttack}</span>
                            </div>
                            <div class="stat-item">
                                <span>Defensa Especial:</span>
                                <span>${displayData.specialDefense || displayData.baseSpecialDefense}</span>
                            </div>
                            <div class="stat-item">
                                <span>Velocidad:</span>
                                <span>${displayData.speed || displayData.baseSpeed}</span>
                            </div>
                        </div>
                        
                        <!-- Información de configuración -->
                        <div class="config-info-section">
                            <h4 style="margin: 0 0 10px 0; font-size: 14px;">Configuración</h4>
                            <div style="font-size: 12px; line-height: 1.4;">
                                <div><strong>Nivel:</strong> ${level}</div>
                                <div><strong>Naturaleza:</strong> ${nature}</div>
                                <div><strong>Objeto:</strong> ${heldItem}</div>
                                <div><strong>Habilidad:</strong> ${selectedAbility}</div>
                            </div>
                        </div>
                        
                        <div class="moves-section">
                            <h4>Movimientos Seleccionados</h4>
                            <div class="selected-moves-list">
                                ${(displayData.selectedMoveIndices || []).map(index => {
                                    const move = displayData.moves[index];
                                    if (!move) return '';
                                    return `
                                        <div class="move-item">
                                            <span class="move-name">${move.name}</span>
                                            <div class="move-details">
                                                <span class="move-power">${move.power || 0} PWR</span>
                                                <span class="move-type type-${(move.type || 'normal').toLowerCase()}">${translateType(move.type || 'normal')}</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Función para seleccionar un Pokémon
        function selectPokemon(id) {
            if (!currentTeam) {
                alert('Primero debes crear o seleccionar un equipo');
                return;
            }

            const pokemon = allPokemon.find(p => p.id === id);
            if (!pokemon) return;

            // Si el equipo está lleno, mostramos un mensaje
            if (teams[currentTeam].filter(p => p !== null).length >= 6) {
                alert('El equipo está completo. Elimina un Pokémon antes de añadir otro.');
                return;
            }

            // Encontramos el primer slot vacío
            const emptySlot = teams[currentTeam].findIndex(p => p === null);
            if (emptySlot !== -1) {
                addToTeam(id, emptySlot);
            }
        }

        // Función para generar un hash único para un Pokémon en un equipo
        function generatePokemonTeamHash(pokemonId, teamName, slotIndex) {
            return `${teamName}_${pokemonId}_${slotIndex}`;
        }

        // Función para obtener los datos de un Pokémon del equipo usando su hash
        function getTeamPokemonData(pokemonId, teamName, slotIndex) {
            const pokemonHash = generatePokemonTeamHash(pokemonId, teamName, slotIndex);
            const savedData = localStorage.getItem(pokemonHash);
            if (savedData) {
                return JSON.parse(savedData);
            }
            return null;
        }

        // Función para guardar los datos de un Pokémon del equipo
        function saveTeamPokemonData(pokemonData, teamName, slotIndex) {
            const pokemonHash = generatePokemonTeamHash(pokemonData.id, teamName, slotIndex);
            localStorage.setItem(pokemonHash, JSON.stringify(pokemonData));
        }

        // Función para añadir un Pokémon al equipo
        function addToTeam(id, slot = null) {
            const pokemon = allPokemon.find(p => p.id === id);
            if (!pokemon) return;

            if (slot === null) {
                slot = teams[currentTeam].findIndex(p => p === null);
            }

            if (slot === -1) {
                alert('El equipo está completo');
                return;
            }

            // Crear un hash único para este Pokémon en este equipo
            const pokemonHash = generatePokemonTeamHash(id, currentTeam, slot);
            
            // Crear una copia profunda de los datos del Pokémon con las estadísticas correctamente inicializadas
            const pokemonData = {
                id: pokemon.id,
                name: pokemon.name,
                types: [...pokemon.types],
                health: pokemon.maxHealth,
                maxHealth: pokemon.maxHealth,
                attack: pokemon.attack || pokemon.baseAttack,
                defense: pokemon.defense || pokemon.baseDefense,
                speed: pokemon.speed || pokemon.baseSpeed,
                specialAttack: pokemon.specialAttack || pokemon.baseSpecialAttack,
                specialDefense: pokemon.specialDefense || pokemon.baseSpecialDefense,
                imageUrl: pokemon.imageUrl,
                moves: pokemon.moves.map(move => ({
                    name: move.name,
                    power: move.power,
                    type: move.type,
                    category: move.category
                })),
                selectedMoveIndices: [], // Inicializar sin movimientos seleccionados
                level: 50, // Nivel por defecto
                stats: {
                    hp: pokemon.maxHealth / 2, // HP base
                    attack: pokemon.baseAttack || pokemon.attack,
                    defense: pokemon.baseDefense || pokemon.defense,
                    speed: pokemon.baseSpeed || pokemon.speed,
                    specialAttack: pokemon.baseSpecialAttack || pokemon.specialAttack,
                    specialDefense: pokemon.baseSpecialDefense || pokemon.specialDefense,
                    // IVs por defecto (perfectos)
                    hpIV: 31,
                    attackIV: 31,
                    defenseIV: 31,
                    specialAttackIV: 31,
                    specialDefenseIV: 31,
                    speedIV: 31,
                    // EVs por defecto (0)
                    hpEV: 0,
                    attackEV: 0,
                    defenseEV: 0,
                    specialAttackEV: 0,
                    specialDefenseEV: 0,
                    speedEV: 0
                }
            };

            // Guardar los datos del Pokémon en localStorage
            localStorage.setItem(pokemonHash, JSON.stringify(pokemonData));

            // Añadir el ID del Pokémon al equipo
            teams[currentTeam][slot] = id;
            updateTeamDisplay();
            updatePokemonGrid();
            saveTeam(); // Guardar automáticamente
        }

        function renderTeamSlot(pokemonId, index) {
            const slot = document.getElementById(`teamSlot${index}`);
            if (!slot) {
                console.warn(`Slot teamSlot${index} no encontrado.`);
                return;
            }
        }

        // Función para eliminar un Pokémon del equipo
        function removeFromTeam(index) {
            const team = teams[currentTeam];
            if (team && team[index]) {
                // Eliminar los datos del Pokémon en el índice especificado
                const oldHash = generatePokemonTeamHash(team[index], currentTeam, index);
                localStorage.removeItem(oldHash);
                
                // Desplazar los Pokémon posteriores hacia atrás
                for (let i = index; i < team.length - 1; i++) {
                    if (team[i + 1]) {
                        // Guardar temporalmente los datos del Pokémon que se va a mover
                        const oldHash = generatePokemonTeamHash(team[i + 1], currentTeam, i + 1);
                        const pokemonData = localStorage.getItem(oldHash);
                        
                        // Eliminar los datos antiguos
                        localStorage.removeItem(oldHash);
                        
                        // Mover el Pokémon
                        team[i] = team[i + 1];
                        
                        // Guardar los datos en la nueva posición
                        if (pokemonData) {
                            const newHash = generatePokemonTeamHash(team[i], currentTeam, i);
                            localStorage.setItem(newHash, pokemonData);
                        }
                    } else {
                        team[i] = null;
                    }
                }
                
                // Añadir un null al final para mantener el tamaño del equipo
                team[team.length - 1] = null;
                
                updateTeamDisplay();
                saveTeam(); // Guardar automáticamente
            }
        }

        // Función para actualizar la visualización del equipo
        function updateTeamDisplay() {
            try {
                const teamSlots = document.querySelectorAll('.team-slot');
                teamSlots.forEach((slot, index) => {
                    const pokemonId = teams[currentTeam][index];
                    slot.dataset.slot = index;
                    
                    if (pokemonId) {
                        const pokemonHash = generatePokemonTeamHash(pokemonId, currentTeam, index);
                        const savedData = localStorage.getItem(pokemonHash);
                        const pokemonData = savedData ? JSON.parse(savedData) : allPokemon.find(p => p.id === pokemonId);
                        
                        console.log(`Actualizando slot ${index} para Pokémon ${pokemonId}:`, {
                            hasSavedData: !!savedData,
                            heldItem: pokemonData?.heldItem,
                            pokemonData: pokemonData
                        });
                        
                        if (pokemonData) {
                            slot.innerHTML = `
                                <img src="${pokemonData.imageUrl}" alt="${pokemonData.name}">
                                <div class="pokemon-name">${pokemonData.name.charAt(0).toUpperCase() + pokemonData.name.slice(1)}</div>
                                <button class="remove-pokemon" onclick="removeFromTeam(${index})">&times;</button>
                            `;
                            slot.classList.add('filled');
                            slot.onclick = () => showMovesModal(pokemonId, currentTeam, index);
                        } else {
                            teams[currentTeam][index] = null;
                            slot.innerHTML = `<div class="slot-placeholder">Slot ${index + 1}</div>`;
                            slot.classList.remove('filled');
                            slot.onclick = null;
                        }
                    } else {
                        slot.innerHTML = `<div class="slot-placeholder">Slot ${index + 1}</div>`;
                        slot.classList.remove('filled');
                        slot.onclick = null;
                    }
                });
            } catch (error) {
                console.error('Error al actualizar la visualización del equipo:', error);
            }
        }

        // Función para actualizar la cuadrícula de Pokémon
        function updatePokemonGrid() {
            try {
                const grid = document.getElementById('pokemonGrid');
                if (allPokemon && allPokemon.length > 0) {
                    grid.innerHTML = allPokemon.map(renderPokemon).join('');
                }
            } catch (error) {
                console.error('Error al actualizar la cuadrícula de Pokémon:', error);
            }
        }

        // Función para guardar el equipo
        async function saveTeam() {
            try {
                const allTeams = {};
                for (const [teamName, team] of Object.entries(teams)) {
                    const teamData = team.filter(id => id !== null).map((id, index) => {
                        const pokemonData = getTeamPokemonData(id, teamName, index);
                        if (!pokemonData) return null;
                        
                        // Guardar los datos del Pokémon usando su hash
                        saveTeamPokemonData(pokemonData, teamName, index);
                        
                        // Devolver el hash para el equipo
                        return generatePokemonTeamHash(id, teamName, index);
                    }).filter(p => p !== null);

                    if (teamData.length > 0) {
                        allTeams[teamName] = teamData;
                    }
                }

                // Guardar los equipos en localStorage
                const teamsJson = JSON.stringify(allTeams);
                localStorage.setItem('pokemonTeams', teamsJson);
                
                // Verificar que se guardó correctamente
                const savedTeams = localStorage.getItem('pokemonTeams');
                if (savedTeams === teamsJson) {
                } else {
                    throw new Error('Error al verificar el guardado');
                }
            } catch (error) {
                console.error('Error al guardar los equipos:', error);
                alert('Error al guardar los equipos. Por favor, intenta de nuevo.');
            }
        }

        // Función para limpiar el equipo
        function clearTeam() {
            if (confirm('¿Estás seguro de que quieres limpiar este equipo?')) {
                teams[currentTeam] = new Array(6).fill(null);
                updateTeamDisplay();
                updatePokemonGrid();
                saveTeam(); // Guardar automáticamente
            }
        }

        // Función para cargar el equipo guardado
        function loadSavedTeam() {
            try {
                const savedTeams = localStorage.getItem('pokemonTeams');
                if (savedTeams) {
                    const loadedTeams = JSON.parse(savedTeams);
                    
                    for (const [teamName, teamHashes] of Object.entries(loadedTeams)) {
                        teams[teamName] = new Array(6).fill(null);
                        const selector = document.getElementById('teamSelector');
                        const option = document.createElement('option');
                        option.value = teamName;
                        option.textContent = teamName;
                        selector.appendChild(option);
                        
                        teamHashes.forEach((pokemonHash, index) => {
                            if (index < 6) {
                                // Extraer el ID del Pokémon del hash
                                const [_, pokemonId] = pokemonHash.split('_');
                                teams[teamName][index] = pokemonId;
                            }
                        });
                    }
                    
                    // Si hay equipos cargados, seleccionar el primero
                    if (Object.keys(teams).length > 0) {
                        currentTeam = Object.keys(teams)[0];
                        document.getElementById('teamSelector').value = currentTeam;
                    }
                    
                    updateTeamDisplay();
                    updatePokemonGrid();
                }
            } catch (error) {
                console.error('Error al cargar los equipos guardados:', error);
                localStorage.removeItem('pokemonTeams');
            }
        }

        // Función para cargar Pokémon
        async function loadPokemon() {
            try {
                const response = await fetch('/api/pokemon');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const pokemon = await response.json();
                allPokemon = pokemon;
                
                const grid = document.getElementById('pokemonGrid');
                grid.innerHTML = pokemon.map(renderPokemon).join('');
                
                document.getElementById('loading').style.display = 'none';
                
                // Cargar el equipo guardado después de cargar los Pokémon
                loadSavedTeam();

                // Iniciar la carga progresiva
                startProgressiveLoading();
            } catch (error) {
                console.error('Error al cargar Pokémon:', error);
                document.getElementById('loading').textContent = 'Error al cargar Pokémon. Por favor, recarga la página.';
            }
        }

        // Función para cargar más Pokémon progresivamente
        async function startProgressiveLoading() {
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = 'block';
            loadingElement.textContent = 'Cargando más Pokémon...';

            try {
                const response = await fetch('/api/pokemon/load-more');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (data.pokemon && data.pokemon.length > 0) {
                    // Actualizar la lista de Pokémon
                    allPokemon = data.pokemon;
                    
                    // Actualizar la cuadrícula
                    const grid = document.getElementById('pokemonGrid');
                    grid.innerHTML = data.pokemon.map(renderPokemon).join('');
                    
                    // Si hay más Pokémon por cargar, continuar
                    if (data.hasMore) {
                        setTimeout(startProgressiveLoading, 1000);
                    } else {
                        loadingElement.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error al cargar más Pokémon:', error);
                loadingElement.textContent = 'Error al cargar más Pokémon. Intenta recargar la página.';
            }
        }

        // Función para buscar Pokémon
        function searchPokemon(query) {
            if (!query) {
                document.getElementById('pokemonGrid').innerHTML = allPokemon.map(renderPokemon).join('');
                return;
            }

            const filteredPokemon = allPokemon.filter(pokemon => 
                pokemon.name.toLowerCase().includes(query.toLowerCase()) ||
                (pokemon.types || []).some(type => type.toLowerCase().includes(query.toLowerCase()))
            );

            document.getElementById('pokemonGrid').innerHTML = filteredPokemon.map(renderPokemon).join('');
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => searchPokemon(e.target.value), 300);
        });

        // Inicialización
        initializeTeamSlots();
        loadPokemon();
        
        // Cargar datos de configuración al inicio
        loadConfigurationData().then(() => {
            console.log('Datos de configuración cargados al inicio');
            console.log('Número de naturalezas cargadas:', Object.keys(allNatures).length);
            console.log('Número de objetos cargados:', Object.keys(allItems).length);
        }).catch(error => {
            console.error('Error al cargar datos de configuración al inicio:', error);
        });

        // Cerrar detalles al hacer clic fuera
        document.addEventListener('click', (e) => {
            const details = document.getElementById('pokemonDetails');
            if (e.target === details) {
                closeDetails();
            }
        });

        // Función para cambiar de equipo
        function changeTeam() {
            const newTeam = document.getElementById('teamSelector').value;
            if (newTeam) {
                currentTeam = newTeam;
                updateTeamDisplay();
                updatePokemonGrid();
            }
        }

        // Función para crear un nuevo equipo
        function createNewTeam() {
            document.getElementById('teamNameModalTitle').textContent = 'Nuevo Equipo';
            document.getElementById('teamNameModal').classList.add('active');
            document.getElementById('newTeamName').value = '';
            document.getElementById('newTeamName').focus();
            saveTeam();
        }

        function editTeamName() {
            const currentName = document.getElementById('teamSelector').value;
            document.getElementById('teamNameModalTitle').textContent = 'Editar Nombre del Equipo';
            document.getElementById('teamNameModal').classList.add('active');
            document.getElementById('newTeamName').value = currentName;
            document.getElementById('newTeamName').focus();
            saveTeam();
        }

        function closeTeamNameModal() {
            document.getElementById('teamNameModal').classList.remove('active');
        }

        function confirmNewTeam() {
            const teamName = document.getElementById('newTeamName').value.trim();
            const isEditing = document.getElementById('teamNameModalTitle').textContent === 'Editar Nombre del Equipo';
            const oldTeamName = document.getElementById('teamSelector').value;
            
            if (!teamName) {
                alert('Por favor, ingresa un nombre para el equipo');
                return;
            }

            // Si estamos editando y el nombre no cambió, solo cerramos el modal
            if (isEditing && teamName === oldTeamName) {
                closeTeamNameModal();
                return;
            }

            // Verificar si el nombre ya existe (excepto si estamos editando el mismo equipo)
            if (teams[teamName] && (!isEditing || teamName !== oldTeamName)) {
                alert('Ya existe un equipo con ese nombre');
                return;
            }

            if (isEditing) {
                // Si estamos editando, necesitamos mover los datos del equipo
                teams[teamName] = teams[oldTeamName];
                
                // Actualizar las referencias en localStorage para cada Pokémon del equipo
                teams[oldTeamName].forEach((pokemonId, index) => {
                    if (pokemonId) {
                        const oldHash = generatePokemonTeamHash(pokemonId, oldTeamName, index);
                        const newHash = generatePokemonTeamHash(pokemonId, teamName, index);
                        const pokemonData = localStorage.getItem(oldHash);
                        if (pokemonData) {
                            localStorage.setItem(newHash, pokemonData);
                            localStorage.removeItem(oldHash);
                        }
                    }
                });

                delete teams[oldTeamName];

                // Actualizar el selector
                const selector = document.getElementById('teamSelector');
                const option = selector.options[selector.selectedIndex];
                option.value = teamName;
                option.textContent = teamName;
                
                currentTeam = teamName;
            } else {
                // Crear un nuevo equipo
                teams[teamName] = new Array(6).fill(null);
                
                const selector = document.getElementById('teamSelector');
                const option = document.createElement('option');
                option.value = teamName;
                option.textContent = teamName;
                selector.appendChild(option);
                selector.value = teamName;
                
                currentTeam = teamName;
            }

            closeTeamNameModal();
            updateTeamDisplay();
            updatePokemonGrid();

            // Guardar inmediatamente el equipo en localStorage
            const allTeams = {};
            for (const [teamName, team] of Object.entries(teams)) {
                const teamData = team.filter(id => id !== null).map((id, index) => {
                    const pokemonData = getTeamPokemonData(id, teamName, index);
                    if (!pokemonData) return null;
                    return generatePokemonTeamHash(id, teamName, index);
                }).filter(p => p !== null);

                if (teamData.length > 0) {
                    allTeams[teamName] = teamData;
                } else {
                    // Incluir equipos vacíos
                    allTeams[teamName] = [];
                }
            }

            localStorage.setItem('pokemonTeams', JSON.stringify(allTeams));
        }

        // Función para eliminar el equipo actual
        function deleteCurrentTeam() {
            if (Object.keys(teams).length <= 1) {
                alert('Debe haber al menos un equipo');
                return;
            }

            if (confirm('¿Estás seguro de que quieres eliminar este equipo?')) {
                const selector = document.getElementById('teamSelector');
                const option = selector.options[selector.selectedIndex];
                selector.removeChild(option);
                delete teams[currentTeam];
                
                // Seleccionar otro equipo disponible
                const remainingTeams = Object.keys(teams);
                if (remainingTeams.length > 0) {
                    currentTeam = remainingTeams[0];
                    selector.value = currentTeam;
                } else {
                    currentTeam = null;
                }
                
                updateTeamDisplay();
                updatePokemonGrid();
                saveTeam();
            }
        }

        // Función para iniciar la batalla
        function startBattle() {
            const validTeams = Object.entries(teams).filter(([_, team]) => 
                team.some(id => id !== null)
            );

            if (validTeams.length < 2) {
                alert('Necesitas al menos dos equipos con Pokémon para iniciar una batalla');
                return;
            }

            const team1 = validTeams[0][1].filter(id => id !== null);
            const team2 = validTeams[1][1].filter(id => id !== null);

            // Preparar datos de los equipos
            const battleTeams = {
                team1: team1.map(id => {
                    const pokemon = allPokemon.find(p => p.id === id);
                    return {
                        id: pokemon.id,
                        name: pokemon.name,
                        types: pokemon.types,
                        health: pokemon.health,
                        maxHealth: pokemon.maxHealth,
                        attack: pokemon.attack,
                        defense: pokemon.defense,
                        speed: pokemon.speed,
                        specialAttack: pokemon.specialAttack,
                        specialDefense: pokemon.specialDefense,
                        imageUrl: pokemon.imageUrl,
                        moves: pokemon.moves,
                        selectedMoveIndices: pokemon.selectedMoveIndices || [0, 1, 2, 3]
                    };
                }),
                team2: team2.map(id => {
                    const pokemon = allPokemon.find(p => p.id === id);
                    return {
                        id: pokemon.id,
                        name: pokemon.name,
                        types: pokemon.types,
                        health: pokemon.health,
                        maxHealth: pokemon.maxHealth,
                        attack: pokemon.attack,
                        defense: pokemon.defense,
                        speed: pokemon.speed,
                        specialAttack: pokemon.specialAttack,
                        specialDefense: pokemon.specialDefense,
                        imageUrl: pokemon.imageUrl,
                        moves: pokemon.moves,
                        selectedMoveIndices: pokemon.selectedMoveIndices || [0, 1, 2, 3]
                    };
                })
            };

            // Guardar datos de la batalla
            localStorage.setItem('battleTeams', JSON.stringify(battleTeams));

            // Redirigir a la página de batalla
            window.location.href = 'battle.html';
        }

        function showMovesModal(pokemonId, teamName, slotIndex) {
            const pokemonData = getTeamPokemonData(pokemonId, teamName, slotIndex);
            if (!pokemonData) {
                alert('No se encontraron datos del Pokémon');
                return;
            }

            console.log('Mostrando modal para:', {
                pokemon: pokemonData.name,
                team: teamName,
                slot: slotIndex,
                hash: generatePokemonTeamHash(pokemonId, teamName, slotIndex)
            });

            selectedPokemonForMoves = {
                ...pokemonData,
                teamName: teamName,
                slotIndex: slotIndex
            };
            selectedMoves = new Set();

            // Si hay movimientos seleccionados previamente, marcarlos
            if (pokemonData.selectedMoveIndices && pokemonData.selectedMoveIndices.length > 0) {
                pokemonData.selectedMoveIndices.forEach(index => {
                    if (pokemonData.moves && pokemonData.moves[index]) {
                        selectedMoves.add(index.toString());
                    }
                });
            }
            
            // Mostrar mensaje de carga si los datos no están disponibles
            const movesContent = document.getElementById('movesContent');
            movesContent.innerHTML = '<div style="text-align: center; padding: 20px;">Cargando configuración...</div>';
            const modal = document.getElementById('movesModal');
            modal.classList.add('active');

            // Cargar datos de configuración
            loadConfigurationData().then(() => {
                loadPokemonAbilities(pokemonId).then(abilities => {
                    console.log('Habilidades cargadas:', abilities);
                    
                    // Actualizar las habilidades del Pokémon
                    selectedPokemonForMoves.abilities = abilities;
                    
                    // Asegurar que los objetos tengan sus efectos extra cargados
                    if (selectedPokemonForMoves.heldItem && selectedPokemonForMoves.heldItem.id) {
                        const allItems = window.allItems || {};
                        const itemData = allItems[selectedPokemonForMoves.heldItem.id];
                        if (itemData && itemData.extraEffects) {
                            selectedPokemonForMoves.heldItem.extraEffects = itemData.extraEffects;
                        }
                    }
                    
                    // Verificar que allItems esté cargado
                    if (!window.allItems || Object.keys(window.allItems).length === 0) {
                        console.error('Los objetos no se han cargado correctamente');
                        alert('Error: No se pudieron cargar los objetos. Por favor, recarga la página.');
                        return;
                    }
                    
                    const movesContent = document.getElementById('movesContent');
                    movesContent.innerHTML = `
                        <div class="tab-container">
                            <button class="tab-button active" onclick="switchTab('moves')">Movimientos</button>
                            <button class="tab-button" onclick="switchTab('abilities')">Habilidades</button>
                            <button class="tab-button" onclick="switchTab('items')">Objetos</button>
                            <button class="tab-button" onclick="switchTab('stats')">Estadísticas</button>
                        </div>

                        <!-- Pestaña Movimientos -->
                        <div id="tab-moves" class="tab-content active">
                            <div class="config-grid">
                                <div>
                                    <h3>Lista de Movimientos Disponibles</h3>
                                    <div class="moves-list">
                                        ${pokemonData.moves.map((move, index) => {
                                            const categoryClass = `category-${(move.category || 'status').toLowerCase()}`;
                                            const isSelected = selectedMoves.has(index.toString());
                                            return `
                                                <div class="move-item ${isSelected ? 'selected' : ''}" 
                                                     onclick="toggleMove(${index})">
                                                    <span class="move-name">${move.name}</span>
                                                    <div class="move-details">
                                                        <span class="move-power">${move.power || 0} PWR</span>
                                                        <span class="move-type type-${(move.type || 'normal').toLowerCase()}">${translateType(move.type || 'normal')}</span>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                                <div class="selected-moves">
                                    <h4>Movimientos Seleccionados (${selectedMoves.size}/4)</h4>
                                    <div id="selectedMovesList"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Pestaña Habilidades -->
                        <div id="tab-abilities" class="tab-content">
                            <div class="config-section-full">
                                <h4>Habilidades</h4>
                                ${abilities.map(ability => `
                                    <div class="ability-item ${pokemonData.selectedAbility && pokemonData.selectedAbility.id === ability.id ? 'selected' : ''}" 
                                         onclick="selectAbility('${ability.id}')">
                                        <div><strong>${ability.name}</strong></div>
                                        <div style="font-size: 12px; color: #666;">${ability.description}</div>
                                        ${ability.isHidden ? '<div style="font-size: 11px; color: #ff6b6b;">Habilidad Oculta</div>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Pestaña Objetos -->
                        <div id="tab-items" class="tab-content">
                            <div class="config-section-full">
                                <h4>Objeto Equipado</h4>
                                <div class="item-item ${!pokemonData.heldItem || pokemonData.heldItem === null || pokemonData.heldItem === undefined ? 'selected' : ''}" onclick="selectItem('')">
                                    <div><strong>Ninguno</strong></div>
                                    <div class="description-text">Sin objeto equipado</div>
                                </div>
                                ${Object.values(window.allItems || allItems || {}).map(item => `
                                    <div class="item-item ${pokemonData.heldItem && pokemonData.heldItem.id === item.id ? 'selected' : ''}" 
                                         onclick="selectItem('${item.id}')">
                                        <div><strong>${item.name}</strong></div>
                                        <div class="description-text">${item.description}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Pestaña Estadísticas -->
                        <div id="tab-stats" class="tab-content">
                            <!-- Selector de Naturaleza -->
                            <div class="nature-selector-section">
                                <h4 style="margin-top: 0;">Naturaleza</h4>
                                <select id="natureSelect" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                                    <option value="">Seleccionar Naturaleza</option>
                                ${Object.values(allNatures).map(nature => `
                                        <option value="${nature.id}" ${pokemonData.nature && pokemonData.nature.id === nature.id ? 'selected' : ''}>
                                            ${nature.name} - ${nature.description}
                                        </option>
                                `).join('')}
                                </select>
                        </div>

                            <!-- Configuración de IVs y EVs -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <h4>IVs (0-31)</h4>
                                    <div class="stat-input-group">
                                        <label>HP: <input type="number" id="hpIV" min="0" max="31" value="${pokemonData.stats ? pokemonData.stats.hpIV || 31 : 31}"></label>
                                        <label>Ataque: <input type="number" id="attackIV" min="0" max="31" value="${pokemonData.stats ? pokemonData.stats.attackIV || 31 : 31}"></label>
                                        <label>Defensa: <input type="number" id="defenseIV" min="0" max="31" value="${pokemonData.stats ? pokemonData.stats.defenseIV || 31 : 31}"></label>
                                        <label>Ataque Especial: <input type="number" id="specialAttackIV" min="0" max="31" value="${pokemonData.stats ? pokemonData.stats.specialAttackIV || 31 : 31}"></label>
                                        <label>Defensa Especial: <input type="number" id="specialDefenseIV" min="0" max="31" value="${pokemonData.stats ? pokemonData.stats.specialDefenseIV || 31 : 31}"></label>
                                        <label>Velocidad: <input type="number" id="speedIV" min="0" max="31" value="${pokemonData.stats ? pokemonData.stats.speedIV || 31 : 31}"></label>
                                    </div>
                                </div>
                                <div>
                                    <h4>EVs (0-252, máximo 510 total)</h4>
                                    <div class="stat-input-group">
                                        <label>HP: <input type="number" id="hpEV" min="0" max="252" value="${pokemonData.stats ? pokemonData.stats.hpEV || 0 : 0}"></label>
                                        <label>Ataque: <input type="number" id="attackEV" min="0" max="252" value="${pokemonData.stats ? pokemonData.stats.attackEV || 0 : 0}"></label>
                                        <label>Defensa: <input type="number" id="defenseEV" min="0" max="252" value="${pokemonData.stats ? pokemonData.stats.defenseEV || 0 : 0}"></label>
                                        <label>Ataque Especial: <input type="number" id="specialAttackEV" min="0" max="252" value="${pokemonData.stats ? pokemonData.stats.specialAttackEV || 0 : 0}"></label>
                                        <label>Defensa Especial: <input type="number" id="specialDefenseEV" min="0" max="252" value="${pokemonData.stats ? pokemonData.stats.specialDefenseEV || 0 : 0}"></label>
                                        <label>Velocidad: <input type="number" id="speedEV" min="0" max="252" value="${pokemonData.stats ? pokemonData.stats.speedEV || 0 : 0}"></label>
                                    </div>
                                    <p id="evTotal" style="margin-top: 10px; font-weight: bold;">Total EVs: 0/510</p>
                                </div>
                            </div>
                            
                            <!-- Nivel -->
                            <div style="margin-bottom: 20px;">
                                <label>Nivel: <input type="number" id="pokemonLevel" min="1" max="100" value="${pokemonData.level || 50}"></label>
                            </div>
                            
                            <!-- Sección de estadísticas en tiempo real -->
                            <div class="stats-calculated-section">
                                <h4 style="margin-top: 0;">Estadísticas Calculadas</h4>
                                <div id="calculatedStats" class="stats-display">
                                    <div class="stat-display"><span>HP:</span><span id="calcHP">0</span></div>
                                    <div class="stat-display"><span>Ataque:</span><span id="calcAttack">0</span></div>
                                    <div class="stat-display"><span>Defensa:</span><span id="calcDefense">0</span></div>
                                    <div class="stat-display"><span>Ataque Especial:</span><span id="calcSpecialAttack">0</span></div>
                                    <div class="stat-display"><span>Defensa Especial:</span><span id="calcSpecialDefense">0</span></div>
                                    <div class="stat-display"><span>Velocidad:</span><span id="calcSpeed">0</span></div>
                                </div>
                            </div>
                        </div>
                    `;

                    updateSelectedMovesList();
                    updateEVTotal();
                    updateCalculatedStats();
                    initializeStatsEventListeners();
                    updateNatureSelection(); // Sincronizar selección visual de naturaleza
                    const modal = document.getElementById('movesModal');
                    modal.classList.add('active');
                });
            });
        }

        function toggleMove(index) {
            const indexStr = index.toString();
            const moveItems = document.querySelectorAll('.move-item');
            const moveItem = moveItems[index];
            
            if (!moveItem) return;

            if (selectedMoves.has(indexStr)) {
                selectedMoves.delete(indexStr);
                moveItem.classList.remove('selected');
            } else if (selectedMoves.size < 4) {
                selectedMoves.add(indexStr);
                moveItem.classList.add('selected');
            } else {
                alert('Solo puedes seleccionar 4 movimientos');
                return;
            }

            updateSelectedMovesList();
            updateMovesList();
            saveAllConfig();
        }

        function updateMovesList() {
            const movesList = document.querySelector('.moves-list');
            if (!movesList || !selectedPokemonForMoves) return;

            movesList.innerHTML = selectedPokemonForMoves.moves.map((move, index) => {
                const categoryClass = `category-${(move.category || 'status').toLowerCase()}`;
                const isSelected = selectedMoves.has(index.toString());
                return `
                    <div class="move-item ${isSelected ? 'selected' : ''}" 
                         onclick="toggleMove(${index})">
                        <span class="move-name">${move.name}</span>
                        <div class="move-details">
                            <span class="move-power">${move.power || 0} PWR</span>
                            <span class="move-type type-${(move.type || 'normal').toLowerCase()}">${translateType(move.type || 'normal')}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateSelectedMovesList() {
            const selectedMovesList = document.getElementById('selectedMovesList');
            if (!selectedMovesList) return;

            const moves = Array.from(selectedMoves).map(indexStr => {
                const index = parseInt(indexStr);
                const move = selectedPokemonForMoves.moves[index];
                console.log('Actualizando movimiento seleccionado:', move, 'en índice', index);
                return `
                    <div class="selected-move-item">
                        <span class="move-name">${move.name}</span>
                        <div class="move-details">
                            <span class="move-power">${move.power || 0} PWR</span>
                            <span class="move-type type-${(move.type || 'normal').toLowerCase()}">${translateType(move.type || 'normal')}</span>
                            <span class="move-category category-${(move.category || 'status').toLowerCase()}">${move.category || 'status'}</span>
                            <button class="remove-move" onclick="removeMove(${index})">&times;</button>
                        </div>
                    </div>
                `;
            }).join('');

            selectedMovesList.innerHTML = moves || '<p>No hay movimientos seleccionados</p>';
            
            // Actualizar el contador
            const counter = document.querySelector('.selected-moves h4');
            if (counter) {
                counter.textContent = `Movimientos Seleccionados (${selectedMoves.size}/4)`;
            }
        }

        function removeMove(index) {
            const indexStr = index.toString();
            selectedMoves.delete(indexStr);
            
            // Actualizar la UI de la lista de movimientos
            const moveItems = document.querySelectorAll('.move-item');
            const moveItem = moveItems[index];
            if (moveItem) {
                moveItem.classList.remove('selected');
            }
            
            updateSelectedMovesList();
            updateMovesList();
        }

        function saveSelectedMoves() {
            if (!selectedPokemonForMoves) return;

            if (selectedMoves.size === 0) {
                alert('Debes seleccionar al menos un movimiento');
                return;
            }

            // Convertir los índices de string a número
            const selectedMoveIndices = Array.from(selectedMoves).map(indexStr => parseInt(indexStr));

            // Crear una copia de los datos del Pokémon
            const updatedPokemonData = {
                ...selectedPokemonForMoves,
                selectedMoveIndices: selectedMoveIndices
            };

            // Guardar los datos actualizados usando el hash específico de esta instancia
            saveTeamPokemonData(
                updatedPokemonData,
                selectedPokemonForMoves.teamName,
                selectedPokemonForMoves.slotIndex
            );
            
            closeMovesModal();
            updateTeamDisplay();
            updatePokemonGrid();
            saveTeam(); // Guardar automáticamente
        }

        function closeMovesModal() {
            document.getElementById('movesModal').classList.remove('active');
            selectedPokemonForMoves = null;
            selectedMoves.clear();
        }

        // Modo oscuro
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }
        // Cargar preferencia de tema al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
            }
        });

        // Variables globales para configuración
        let allNatures = {};
        let allItems = {};
        let currentConfigPokemon = null;

        // Función para cargar naturalezas y objetos
        async function loadConfigurationData() {
            try {
                console.log('Iniciando carga de datos de configuración...');
                
                const [naturesResponse, itemsResponse] = await Promise.all([
                    fetch('/api/pokemon/natures'),
                    fetch('/api/pokemon/items')
                ]);
                
                if (naturesResponse.ok) {
                    allNatures = await naturesResponse.json();
                    window.allNatures = allNatures; // Hacer global
                    console.log('Naturalezas cargadas:', Object.keys(allNatures).length);
                } else {
                    console.error('Error al cargar naturalezas:', naturesResponse.status);
                }
                
                if (itemsResponse.ok) {
                    allItems = await itemsResponse.json();
                    window.allItems = allItems; // Hacer global
                    console.log('Objetos cargados:', Object.keys(allItems).length);
                } else {
                    console.error('Error al cargar objetos:', itemsResponse.status);
                }
                
                // Verificar que se cargaron correctamente
                if (!allNatures || Object.keys(allNatures).length === 0) {
                    console.warn('No se cargaron naturalezas');
                }
                
                if (!allItems || Object.keys(allItems).length === 0) {
                    console.warn('No se cargaron objetos');
                }
                
                console.log('Carga de datos de configuración completada');
            } catch (error) {
                console.error('Error al cargar datos de configuración:', error);
                throw error; // Re-lanzar el error para que pueda ser manejado por el llamador
            }
        }

        // Función para mostrar el modal de configuración de Pokémon
        async function showPokemonConfig(pokemonId) {
            currentConfigPokemon = pokemonId;
            const pokemon = allPokemon.find(p => p.id === pokemonId);
            if (!pokemon) return;

            // Cargar datos de configuración si no están cargados
            if (Object.keys(allNatures).length === 0 || Object.keys(allItems).length === 0) {
                await loadConfigurationData();
            }
            
            // Verificar que los datos se cargaron correctamente
            if (!allItems || Object.keys(allItems).length === 0) {
                console.error('Los objetos no se han cargado correctamente');
                alert('Error: No se pudieron cargar los objetos. Por favor, recarga la página.');
                return;
            }

            // Cargar habilidades del Pokémon
            let abilities = [];
            try {
                const abilitiesResponse = await fetch(`/api/pokemon/${pokemonId}/abilities`);
                if (abilitiesResponse.ok) {
                    abilities = await abilitiesResponse.json();
                }
            } catch (error) {
                console.error('Error al cargar habilidades:', error);
            }

            // Obtener configuración actual del Pokémon
            let currentConfig = {};
            if (currentTeam && teams[currentTeam]) {
                for (const [teamName, team] of Object.entries(teams)) {
                    const index = team.indexOf(pokemonId);
                    if (index !== -1) {
                        const pokemonHash = generatePokemonTeamHash(pokemonId, teamName, index);
                        const savedData = localStorage.getItem(pokemonHash);
                        if (savedData) {
                            currentConfig = JSON.parse(savedData);
                            break;
                        }
                    }
                }
            }

            const content = document.getElementById('pokemonConfigContent');
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <img src="${pokemon.imageUrl}" alt="${pokemon.name}" style="width: 150px; height: 150px; object-fit: contain;">
                        <h4>${pokemon.name}</h4>
                        <div class="pokemon-types">
                            ${pokemon.types.map(type => 
                                `<span class="type-badge type-${type.toLowerCase()}">${translateType(type)}</span>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <div class="config-section">
                            <h4>Habilidades</h4>
                            ${abilities.map(ability => `
                                <div class="ability-item ${currentConfig.selectedAbility && currentConfig.selectedAbility.id === ability.id ? 'selected' : ''}" 
                                     onclick="selectAbility('${ability.id}')">
                                    <div><strong>${ability.name}</strong></div>
                                    <div style="font-size: 12px; color: #666;">${ability.description}</div>
                                    ${ability.isHidden ? '<div style="font-size: 11px; color: #ff6b6b;">Habilidad Oculta</div>' : ''}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="config-section">
                            <h4>Objeto Equipado</h4>
                            <div class="item-item ${!currentConfig.heldItem ? 'selected' : ''}" onclick="selectItem('')">
                                <div><strong>Ninguno</strong></div>
                                <div style="font-size: 12px; color: #666;">Sin objeto equipado</div>
                            </div>
                            ${Object.values(window.allItems || allItems || {}).map(item => `
                                <div class="item-item ${currentConfig.heldItem && currentConfig.heldItem.id === item.id ? 'selected' : ''}" 
                                     onclick="selectItem('${item.id}')">
                                    <div><strong>${item.name}</strong></div>
                                    <div style="font-size: 12px; color: #666;">${item.description}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="config-section">
                            <h4>Naturaleza</h4>
                            ${Object.values(allNatures).map(nature => `
                                <div class="nature-item ${currentConfig.nature && currentConfig.nature.id === nature.id ? 'selected' : ''}" 
                                     onclick="selectNature('${nature.id}')">
                                    <div><strong>${nature.name}</strong></div>
                                    <div style="font-size: 12px; color: #666;">${nature.description}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <button onclick="savePokemonConfig()" style="margin-top: 20px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Guardar Configuración
                </button>
            `;

            document.getElementById('pokemonConfigModal').classList.add('active');
        }

        // Función para mostrar el modal de configuración de estadísticas
        async function showStatsConfig(pokemonId) {
            currentConfigPokemon = pokemonId;
            
            // Obtener configuración actual del Pokémon
            let currentConfig = {};
            if (currentTeam && teams[currentTeam]) {
                for (const [teamName, team] of Object.entries(teams)) {
                    const index = team.indexOf(pokemonId);
                    if (index !== -1) {
                        const pokemonHash = generatePokemonTeamHash(pokemonId, teamName, index);
                        const savedData = localStorage.getItem(pokemonHash);
                        if (savedData) {
                            currentConfig = JSON.parse(savedData);
                            break;
                        }
                    }
                }
            }

            // Cargar estadísticas actuales
            try {
                const statsResponse = await fetch(`/api/pokemon/${pokemonId}/stats`);
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    
                    // Rellenar formulario con valores actuales
                    if (stats.baseStats) {
                        document.getElementById('hpIV').value = stats.baseStats.hpIV || 31;
                        document.getElementById('attackIV').value = stats.baseStats.attackIV || 31;
                        document.getElementById('defenseIV').value = stats.baseStats.defenseIV || 31;
                        document.getElementById('specialAttackIV').value = stats.baseStats.specialAttackIV || 31;
                        document.getElementById('specialDefenseIV').value = stats.baseStats.specialDefenseIV || 31;
                        document.getElementById('speedIV').value = stats.baseStats.speedIV || 31;
                        
                        document.getElementById('hpEV').value = stats.baseStats.hpEV || 0;
                        document.getElementById('attackEV').value = stats.baseStats.attackEV || 0;
                        document.getElementById('defenseEV').value = stats.baseStats.defenseEV || 0;
                        document.getElementById('specialAttackEV').value = stats.baseStats.specialAttackEV || 0;
                        document.getElementById('specialDefenseEV').value = stats.baseStats.specialDefenseEV || 0;
                        document.getElementById('speedEV').value = stats.baseStats.speedEV || 0;
                    }
                    
                    document.getElementById('pokemonLevel').value = stats.level || 50;
                    
                    updateEVTotal();
                    updateCalculatedStats();
                    initializeStatsEventListeners();
                    updateNatureSelection(); // Sincronizar selección visual de naturaleza
                }
            } catch (error) {
                console.error('Error al cargar estadísticas:', error);
            }

            document.getElementById('statsConfigModal').classList.add('active');
        }

        // Función para inicializar event listeners de estadísticas
        function initializeStatsEventListeners() {
            const evInputs = ['hpEV', 'attackEV', 'defenseEV', 'specialAttackEV', 'specialDefenseEV', 'speedEV'];
            const ivInputs = ['hpIV', 'attackIV', 'defenseIV', 'specialAttackIV', 'specialDefenseIV', 'speedIV'];
            const levelInput = 'pokemonLevel';
            
            // Event listeners para EVs
            evInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    // Remover event listeners existentes para evitar duplicados
                    element.removeEventListener('input', updateEVTotal);
                    element.removeEventListener('input', updateCalculatedStats);
                    
                    // Agregar nuevos event listeners
                    element.addEventListener('input', () => {
                        updateEVTotal();
                        updateCalculatedStats();
                    });
                }
            });
            
            // Event listeners para IVs
            ivInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    // Remover event listeners existentes
                    element.removeEventListener('input', updateCalculatedStats);
                    
                    // Agregar nuevo event listener
                    element.addEventListener('input', updateCalculatedStats);
                }
            });
            
            // Event listener para nivel
            const levelElement = document.getElementById(levelInput);
            if (levelElement) {
                // Remover event listener existente
                levelElement.removeEventListener('input', updateCalculatedStats);
                
                // Agregar nuevo event listener
                levelElement.addEventListener('input', () => {
                    updateCalculatedStats();
                    saveAllConfig();
                });
            }
            
            // Event listener para selector de naturaleza
            const natureSelect = document.getElementById('natureSelect');
            if (natureSelect) {
                // Remover event listener existente
                natureSelect.removeEventListener('change', updateCalculatedStats);
                natureSelect.removeEventListener('change', updateNatureSelection);
                
                // Agregar nuevos event listeners
                natureSelect.addEventListener('change', updateCalculatedStats);
                natureSelect.addEventListener('change', updateNatureSelection);
            }
        }

        // Event listeners para EVs
        document.addEventListener('DOMContentLoaded', () => {
            const evInputs = ['hpEV', 'attackEV', 'defenseEV', 'specialAttackEV', 'specialDefenseEV', 'speedEV'];
            const ivInputs = ['hpIV', 'attackIV', 'defenseIV', 'specialAttackIV', 'specialDefenseIV', 'speedIV'];
            const levelInput = 'pokemonLevel';
            
            // Event listeners para EVs
            evInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => {
                        updateEVTotal();
                        updateCalculatedStats();
                    });
                }
            });
            
            // Event listeners para IVs
            ivInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateCalculatedStats);
                }
            });
            
            // Event listener para nivel
            const levelElement = document.getElementById(levelInput);
            if (levelElement) {
                levelElement.addEventListener('input', updateCalculatedStats);
            }
        });

        // Función para calcular estadísticas en tiempo real
        function updateCalculatedStats() {
            // Determinar qué Pokémon usar para los cálculos
            let pokemonData = null;
            
            if (selectedPokemonForMoves) {
                // Modal principal de movimientos
                pokemonData = selectedPokemonForMoves;
            } else if (currentConfigPokemon) {
                // Modal independiente de estadísticas
                pokemonData = allPokemon.find(p => p.id === currentConfigPokemon);
            }
            
            if (!pokemonData) return;
            
            // Obtener valores de IVs
            const hpIV = parseInt(document.getElementById('hpIV')?.value) || 31;
            const attackIV = parseInt(document.getElementById('attackIV')?.value) || 31;
            const defenseIV = parseInt(document.getElementById('defenseIV')?.value) || 31;
            const specialAttackIV = parseInt(document.getElementById('specialAttackIV')?.value) || 31;
            const specialDefenseIV = parseInt(document.getElementById('specialDefenseIV')?.value) || 31;
            const speedIV = parseInt(document.getElementById('speedIV')?.value) || 31;
            
            // Obtener valores de EVs
            const hpEV = parseInt(document.getElementById('hpEV')?.value) || 0;
            const attackEV = parseInt(document.getElementById('attackEV')?.value) || 0;
            const defenseEV = parseInt(document.getElementById('defenseEV')?.value) || 0;
            const specialAttackEV = parseInt(document.getElementById('specialAttackEV')?.value) || 0;
            const specialDefenseEV = parseInt(document.getElementById('specialDefenseEV')?.value) || 0;
            const speedEV = parseInt(document.getElementById('speedEV')?.value) || 0;
            
            // Obtener nivel
            const level = parseInt(document.getElementById('pokemonLevel')?.value) || 50;
            
            
            // Obtener naturaleza seleccionada
            const natureSelect = document.getElementById('natureSelect');
            let natureModifiers = { attack: 1, defense: 1, specialAttack: 1, specialDefense: 1, speed: 1 };
            
            if (natureSelect && natureSelect.value) {
                const selectedNature = allNatures[natureSelect.value];
                if (selectedNature) {
                    natureModifiers = {
                        attack: parseFloat(selectedNature.attackModifier) || 1,
                        defense: parseFloat(selectedNature.defenseModifier) || 1,
                        specialAttack: parseFloat(selectedNature.specialAttackModifier) || 1,
                        specialDefense: parseFloat(selectedNature.specialDefenseModifier) || 1,
                        speed: parseFloat(selectedNature.speedModifier) || 1
                    };
                }
            }
            
            // Obtener estadísticas base del Pokémon
            let baseStats = pokemonData.baseStats;
            if (!baseStats) {
                // Buscar en allPokemon por id si no están presentes
                const original = allPokemon.find(p => p.id === pokemonData.id);
                baseStats = original?.baseStats || {
                    hp: original?.maxHealth || 100,
                    attack: original?.baseAttack || 50,
                    defense: original?.baseDefense || 50,
                    specialAttack: original?.baseSpecialAttack || 50,
                    specialDefense: original?.baseSpecialDefense || 50,
                    speed: original?.baseSpeed || 50
                };
            }

            const baseHP = baseStats.hp;
            const baseAttack = baseStats.attack;
            const baseDefense = baseStats.defense;
            const baseSpecialAttack = baseStats.specialAttack;
            const baseSpecialDefense = baseStats.specialDefense;
            const baseSpeed = baseStats.speed;

            // Calcular estadísticas finales usando la fórmula de Pokémon con modificadores de naturaleza
            const calculatedStats = {
                hp: Math.floor(((2 * baseHP + hpIV + Math.floor(hpEV / 4)) * level) / 100) + level + 10,
                attack: Math.floor(((2 * baseAttack + attackIV + Math.floor(attackEV / 4)) * level) / 100) + 5,
                defense: Math.floor(((2 * baseDefense + defenseIV + Math.floor(defenseEV / 4)) * level) / 100) + 5,
                specialAttack: Math.floor(((2 * baseSpecialAttack + specialAttackIV + Math.floor(specialAttackEV / 4)) * level) / 100) + 5,
                specialDefense: Math.floor(((2 * baseSpecialDefense + specialDefenseIV + Math.floor(specialDefenseEV / 4)) * level) / 100) + 5,
                speed: Math.floor(((2 * baseSpeed + speedIV + Math.floor(speedEV / 4)) * level) / 100) + 5
            };

            // Aplicar modificadores de naturaleza (excepto HP)
            calculatedStats.attack = Math.floor(calculatedStats.attack * natureModifiers.attack);
            calculatedStats.defense = Math.floor(calculatedStats.defense * natureModifiers.defense);
            calculatedStats.specialAttack = Math.floor(calculatedStats.specialAttack * natureModifiers.specialAttack);
            calculatedStats.specialDefense = Math.floor(calculatedStats.specialDefense * natureModifiers.specialDefense);
            calculatedStats.speed = Math.floor(calculatedStats.speed * natureModifiers.speed);
            
            // Actualizar elementos en el DOM
            const calcElements = {
                hp: document.getElementById('calcHP'),
                attack: document.getElementById('calcAttack'),
                defense: document.getElementById('calcDefense'),
                specialAttack: document.getElementById('calcSpecialAttack'),
                specialDefense: document.getElementById('calcSpecialDefense'),
                speed: document.getElementById('calcSpeed')
            };
            
            if (calcElements.hp) calcElements.hp.textContent = calculatedStats.hp;
            if (calcElements.attack) calcElements.attack.textContent = calculatedStats.attack;
            if (calcElements.defense) calcElements.defense.textContent = calculatedStats.defense;
            if (calcElements.specialAttack) calcElements.specialAttack.textContent = calculatedStats.specialAttack;
            if (calcElements.specialDefense) calcElements.specialDefense.textContent = calculatedStats.specialDefense;
            if (calcElements.speed) calcElements.speed.textContent = calculatedStats.speed;
        }

        // Función para actualizar el total de EVs (mejorada)
        function updateEVTotal() {
            const hpEV = parseInt(document.getElementById('hpEV')?.value) || 0;
            const attackEV = parseInt(document.getElementById('attackEV')?.value) || 0;
            const defenseEV = parseInt(document.getElementById('defenseEV')?.value) || 0;
            const specialAttackEV = parseInt(document.getElementById('specialAttackEV')?.value) || 0;
            const specialDefenseEV = parseInt(document.getElementById('specialDefenseEV')?.value) || 0;
            const speedEV = parseInt(document.getElementById('speedEV')?.value) || 0;
            
            const total = hpEV + attackEV + defenseEV + specialAttackEV + specialDefenseEV + speedEV;
            const element = document.getElementById('evTotal');
            if (element) {
                element.textContent = `Total EVs: ${total}/510`;
                element.style.color = total > 510 ? '#ff4444' : total === 510 ? '#4CAF50' : '#333';
            }
            saveAllConfig();
        }

        // Función para guardar configuración de Pokémon
        async function savePokemonConfig() {
            if (!currentConfigPokemon) return;

            const selectedAbility = document.querySelector('.ability-item.selected');
            const selectedItem = document.querySelector('.item-item.selected');
            const selectedNature = document.querySelector('.nature-item.selected');

            const config = {
                selectedAbilityId: selectedAbility ? selectedAbility.querySelector('strong').textContent : null,
                heldItemId: selectedItem ? selectedItem.querySelector('strong').textContent === 'Ninguno' ? '' : selectedItem.querySelector('strong').textContent : '',
                natureId: selectedNature ? selectedNature.querySelector('strong').textContent : null
            };

            try {
                const response = await fetch(`/api/pokemon/${currentConfigPokemon}/configure`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    const updatedPokemon = await response.json();
                    
                    // Actualizar datos en localStorage si está en un equipo
                    if (currentTeam && teams[currentTeam]) {
                        for (const [teamName, team] of Object.entries(teams)) {
                            const index = team.indexOf(currentConfigPokemon);
                            if (index !== -1) {
                                const pokemonHash = generatePokemonTeamHash(currentConfigPokemon, teamName, index);
                                const savedData = localStorage.getItem(pokemonHash);
                                if (savedData) {
                                    const currentData = JSON.parse(savedData);
                                    const newData = { ...currentData, ...updatedPokemon };
                                    localStorage.setItem(pokemonHash, JSON.stringify(newData));
                                    break;
                                }
                            }
                        }
                    }
                    
                    closePokemonConfigModal();
                    updatePokemonGrid();
                    alert('Configuración guardada exitosamente');
                } else {
                    const error = await response.json();
                    alert('Error al guardar configuración: ' + error.error);
                }
            } catch (error) {
                console.error('Error al guardar configuración:', error);
                alert('Error al guardar configuración');
            }
        }

        // Función para guardar configuración de estadísticas
        async function saveStatsConfig() {
            if (!currentConfigPokemon) return;

            const total = parseInt(document.getElementById('hpEV').value) + 
                         parseInt(document.getElementById('attackEV').value) + 
                         parseInt(document.getElementById('defenseEV').value) + 
                         parseInt(document.getElementById('specialAttackEV').value) + 
                         parseInt(document.getElementById('specialDefenseEV').value) + 
                         parseInt(document.getElementById('speedEV').value);

            if (total > 510) {
                alert('Los EVs totales no pueden exceder 510');
                return;
            }

            const config = {
                ivs: {
                    hp: parseInt(document.getElementById('hpIV').value),
                    attack: parseInt(document.getElementById('attackIV').value),
                    defense: parseInt(document.getElementById('defenseIV').value),
                    specialAttack: parseInt(document.getElementById('specialAttackIV').value),
                    specialDefense: parseInt(document.getElementById('specialDefenseIV').value),
                    speed: parseInt(document.getElementById('speedIV').value)
                },
                evs: {
                    hp: parseInt(document.getElementById('hpEV').value),
                    attack: parseInt(document.getElementById('attackEV').value),
                    defense: parseInt(document.getElementById('defenseEV').value),
                    specialAttack: parseInt(document.getElementById('specialAttackEV').value),
                    specialDefense: parseInt(document.getElementById('specialDefenseEV').value),
                    speed: parseInt(document.getElementById('speedEV').value)
                },
                level: parseInt(document.getElementById('pokemonLevel').value)
            };

            try {
                const response = await fetch(`/api/pokemon/${currentConfigPokemon}/configure`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    const updatedPokemon = await response.json();
                    
                    // Actualizar datos en localStorage si está en un equipo
                    if (currentTeam && teams[currentTeam]) {
                        for (const [teamName, team] of Object.entries(teams)) {
                            const index = team.indexOf(currentConfigPokemon);
                            if (index !== -1) {
                                const pokemonHash = generatePokemonTeamHash(currentConfigPokemon, teamName, index);
                                const savedData = localStorage.getItem(pokemonHash);
                                if (savedData) {
                                    const currentData = JSON.parse(savedData);
                                    const newData = { ...currentData, ...updatedPokemon };
                                    localStorage.setItem(pokemonHash, JSON.stringify(newData));
                                    break;
                                }
                            }
                        }
                    }
                    
                    closeStatsConfigModal();
                    updatePokemonGrid();
                    alert('Estadísticas guardadas exitosamente');
                } else {
                    const error = await response.json();
                    alert('Error al guardar estadísticas: ' + error.error);
                }
            } catch (error) {
                console.error('Error al guardar estadísticas:', error);
                alert('Error al guardar estadísticas');
            }
        }

        // Funciones para cerrar modales
        function closePokemonConfigModal() {
            document.getElementById('pokemonConfigModal').classList.remove('active');
            currentConfigPokemon = null;
        }

        function closeStatsConfigModal() {
            document.getElementById('statsConfigModal').classList.remove('active');
            currentConfigPokemon = null;
        }

        // Función para cambiar pestañas
        function switchTab(tabName) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Mostrar la pestaña seleccionada
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Activar el botón correspondiente
            event.target.classList.add('active');
        }

        // Función para cargar habilidades de un Pokémon
        async function loadPokemonAbilities(pokemonId) {
            try {
                const response = await fetch(`/api/pokemon/${pokemonId}/abilities`);
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('Error al cargar habilidades:', error);
            }
            return [];
        }

        // Función para guardar toda la configuración
        async function saveAllConfig() {
            if (!selectedPokemonForMoves) {
                alert('No hay Pokémon seleccionado para configurar');
                return;
            }

            console.log('Iniciando guardado de configuración para:', selectedPokemonForMoves);

            // Validar EVs
            const total = parseInt(document.getElementById('hpEV').value) + 
                         parseInt(document.getElementById('attackEV').value) + 
                         parseInt(document.getElementById('defenseEV').value) + 
                         parseInt(document.getElementById('specialAttackEV').value) + 
                         parseInt(document.getElementById('specialDefenseEV').value) + 
                         parseInt(document.getElementById('speedEV').value);

            if (total > 510) {
                alert('Los EVs totales no pueden exceder 510');
                return;
            }

            // Validar movimientos
            if (selectedMoves.size === 0) {
                alert('Debes seleccionar al menos un movimiento');
                return;
            }

            // Obtener habilidad seleccionada
            let selectedAbilityId = null;
            const selectedAbilityElement = document.querySelector('.ability-item.selected');
            if (selectedAbilityElement) {
                const abilityName = selectedAbilityElement.querySelector('strong').textContent;
                // Buscar la habilidad por nombre en las habilidades del Pokémon
                const abilities = selectedPokemonForMoves.abilities || [];
                const ability = abilities.find(ab => ab.name === abilityName);
                if (ability) {
                    selectedAbilityId = ability.id;
                }
            }

            // Obtener objeto seleccionado
            let heldItemId = '';
            const selectedItemElement = document.querySelector('.item-item.selected');
            if (selectedItemElement) {
                const itemName = selectedItemElement.querySelector('strong').textContent;
                console.log('Objeto seleccionado en UI:', itemName);
                if (itemName === 'Ninguno') {
                    heldItemId = ''; // Cadena vacía para indicar que no hay objeto
                    console.log('Configurando Pokémon sin objeto (heldItemId = "")');
                } else {
                    // Buscar el objeto por nombre en todos los objetos
                    const allItems = window.allItems || {};
                    const item = Object.values(allItems).find(item => item.name === itemName);
                    if (item) {
                        heldItemId = item.id;
                        console.log('Configurando objeto:', itemName, 'ID:', item.id);
                    } else {
                        console.log('Objeto no encontrado en la base de datos:', itemName);
                        // Si no se encuentra por nombre, intentar usar el itemId directamente
                        if (selectedPokemonForMoves && selectedPokemonForMoves.heldItem && selectedPokemonForMoves.heldItem.id) {
                            heldItemId = selectedPokemonForMoves.heldItem.id;
                            console.log('Usando ID del objeto en memoria:', heldItemId);
                        }
                    }
                }
            } else {
                console.log('No hay objeto seleccionado');
                // Si no hay elemento seleccionado pero hay objeto en memoria, mantenerlo
                if (selectedPokemonForMoves && selectedPokemonForMoves.heldItem && selectedPokemonForMoves.heldItem.id) {
                    heldItemId = selectedPokemonForMoves.heldItem.id;
                    console.log('Manteniendo objeto existente:', heldItemId);
                }
            }
            
            console.log('Valor final de heldItemId:', heldItemId, 'Tipo:', typeof heldItemId);

            // Obtener naturaleza seleccionada
            let natureId = null;
            const natureSelect = document.getElementById('natureSelect');
            if (natureSelect && natureSelect.value) {
                natureId = natureSelect.value;
            }

            const config = {
                // Movimientos
                selectedMoveIndices: Array.from(selectedMoves).map(indexStr => parseInt(indexStr)),
                
                // Habilidades, objetos y naturalezas
                selectedAbilityId: selectedAbilityId,
                heldItemId: heldItemId,
                natureId: natureId,
                
                // IVs y EVs
                ivs: {
                    hp: parseInt(document.getElementById('hpIV').value),
                    attack: parseInt(document.getElementById('attackIV').value),
                    defense: parseInt(document.getElementById('defenseIV').value),
                    specialAttack: parseInt(document.getElementById('specialAttackIV').value),
                    specialDefense: parseInt(document.getElementById('specialDefenseIV').value),
                    speed: parseInt(document.getElementById('speedIV').value)
                },
                evs: {
                    hp: parseInt(document.getElementById('hpEV').value),
                    attack: parseInt(document.getElementById('attackEV').value),
                    defense: parseInt(document.getElementById('defenseEV').value),
                    specialAttack: parseInt(document.getElementById('specialAttackEV').value),
                    specialDefense: parseInt(document.getElementById('specialDefenseEV').value),
                    speed: parseInt(document.getElementById('speedEV').value)
                },
                level: parseInt(document.getElementById('pokemonLevel').value)
            };

            console.log('Configuración a enviar:', config);

            try {
                const response = await fetch(`/api/pokemon/${selectedPokemonForMoves.id}/configure`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                console.log('Respuesta del servidor:', response.status, response.statusText);

                if (response.ok) {
                    const updatedPokemon = await response.json();
                    console.log('Pokémon actualizado:', updatedPokemon);
                    
                    // Actualizar datos en localStorage
                    const pokemonHash = generatePokemonTeamHash(
                        selectedPokemonForMoves.id, 
                        selectedPokemonForMoves.teamName, 
                        selectedPokemonForMoves.slotIndex
                    );
                    
                    const currentData = JSON.parse(localStorage.getItem(pokemonHash) || '{}');
                    const newData = { ...currentData, ...updatedPokemon };
                    
                    // Asegurar que heldItem se actualice correctamente
                    if (updatedPokemon.heldItem === null || updatedPokemon.heldItem === undefined) {
                        newData.heldItem = null;
                        console.log('Objeto removido en localStorage');
                    } else if (updatedPokemon.heldItem) {
                        // Asegurar que el objeto tenga sus efectos extra
                        const allItems = window.allItems || {};
                        const itemData = allItems[updatedPokemon.heldItem.id];
                        if (itemData) {
                            newData.heldItem = {
                                id: itemData.id,
                                name: itemData.name,
                                description: itemData.description,
                                extraEffects: itemData.extraEffects || {}
                            };
                            console.log('Objeto guardado en localStorage con efectos extra:', newData.heldItem);
                        } else {
                            console.warn('No se encontró el objeto en allItems:', updatedPokemon.heldItem.id);
                            // Mantener el objeto como está si no se encuentra en allItems
                            newData.heldItem = updatedPokemon.heldItem;
                        }
                    }
                    
                    localStorage.setItem(pokemonHash, JSON.stringify(newData));
                    
                    // Forzar la actualización inmediata de la UI
                    setTimeout(() => {
                        updateTeamDisplay();
                        updatePokemonGrid();
                    }, 100);
                    
                    //closeMovesModal();
                    console.log('Configuración guardada exitosamente');
                } else {
                    const errorData = await response.json();
                    console.error('Error del servidor:', errorData);
                    alert('Error al guardar configuración: ' + (errorData.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error al guardar configuración:', error);
                alert('Error de conexión al guardar configuración: ' + error.message);
            }
        }

        // Actualizar las funciones de selección para trabajar con el nuevo modal
        function selectAbility(abilityId) {
            document.querySelectorAll('.ability-item').forEach(item => item.classList.remove('selected'));
            event.target.closest('.ability-item').classList.add('selected');
            console.log('Habilidad seleccionada:', event.target.closest('.ability-item').querySelector('strong').textContent);
            saveAllConfig();
        }

        function selectItem(itemId) {
            document.querySelectorAll('.item-item').forEach(item => item.classList.remove('selected'));
            event.target.closest('.item-item').classList.add('selected');
            
            const selectedItem = event.target.closest('.item-item');
            const itemName = selectedItem.querySelector('strong').textContent;
            console.log('Objeto seleccionado:', itemName, 'ID:', itemId);
            
            // Si se selecciona "Ninguno", el itemId será una cadena vacía
            if (itemName === 'Ninguno') {
                console.log('Removiendo objeto del Pokémon');
            }
            
            // Actualizar inmediatamente los datos del Pokémon en memoria
            if (selectedPokemonForMoves) {
                if (itemName === 'Ninguno') {
                    selectedPokemonForMoves.heldItem = null;
                } else {
                    // Buscar el objeto por ID en allItems
                    const allItems = window.allItems || {};
                    const item = allItems[itemId];
                    if (item) {
                        selectedPokemonForMoves.heldItem = {
                            id: item.id,
                            name: item.name,
                            description: item.description
                        };
                    }
                }
            }
            
            saveAllConfig();
        }

        function selectNature(natureId) {
            document.querySelectorAll('.nature-item').forEach(item => item.classList.remove('selected'));
            event.target.closest('.nature-item').classList.add('selected');
            console.log('Naturaleza seleccionada:', event.target.closest('.nature-item').querySelector('strong').textContent);
            
            // Actualizar el selector de naturaleza en el modal si existe
            const natureSelect = document.getElementById('natureSelect');
            if (natureSelect) {
                natureSelect.value = natureId;
                // Disparar el evento change para actualizar las estadísticas
                natureSelect.dispatchEvent(new Event('change'));
            }
            
            saveAllConfig();
        }

        // Función para actualizar la selección visual de naturaleza cuando cambia el selector
        function updateNatureSelection() {
            const natureSelect = document.getElementById('natureSelect');
            if (!natureSelect || !natureSelect.value) return;
            
            // Remover selección previa
            document.querySelectorAll('.nature-item').forEach(item => item.classList.remove('selected'));
            
            // Buscar y seleccionar el elemento correspondiente
            const natureItems = document.querySelectorAll('.nature-item');
            natureItems.forEach(item => {
                const natureName = item.querySelector('strong').textContent;
                const selectedNature = allNatures[natureSelect.value];
                if (selectedNature && selectedNature.name === natureName) {
                    item.classList.add('selected');
                }
            });
            saveAllConfig();
        }
        
        // Función para verificar si los datos de configuración están cargados
        function isConfigurationLoaded() {
            const hasNatures = allNatures && Object.keys(allNatures).length > 0;
            const hasItems = allItems && Object.keys(allItems).length > 0;
            return hasNatures && hasItems;
        }
        
        // Función para mostrar mensaje de error si los datos no están cargados
        function showConfigurationError() {
            alert('Error: Los datos de configuración no se han cargado correctamente. Por favor, recarga la página.');
        }
    </script>
</body>
</html> 